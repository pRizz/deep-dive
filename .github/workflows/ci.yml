name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        working-directory: ui
        run: npm ci

      - name: Lint UI
        working-directory: ui
        run: npm run lint

      - name: Test UI
        working-directory: ui
        run: npm run test -- --run

      - name: Build UI
        working-directory: ui
        run: npm run build

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: vm/go.mod

      - name: Test Go
        working-directory: vm
        run: go test ./...

      - name: Vet Go
        working-directory: vm
        run: go vet ./...

      - name: Build extension image
        run: docker build -t dive-in:ci .

      - name: Install Docker Extensions CLI
        run: |
          set -euo pipefail
          RELEASE_JSON=$(curl -fsSL https://api.github.com/repos/docker/extension-sdk/releases/latest)
          ASSET_URL=$(python -c 'import json,os,re; data=json.loads(os.environ["RELEASE_JSON"]); pattern=re.compile(r"linux-amd64$"); print(next((a.get("browser_download_url","") for a in data.get("assets",[]) if pattern.search(a.get("name",""))), ""))')
          if [ -z "$ASSET_URL" ]; then
            echo "Docker Extensions CLI asset not found." >&2
            exit 1
          fi
          CLI_PATH=$(ASSET_URL="$ASSET_URL" python -c $'import os,tarfile,tempfile,urllib.request\nurl=os.environ["ASSET_URL"]\ntmpdir=tempfile.mkdtemp()\narchive_path=os.path.join(tmpdir,"docker-extension-asset")\nurllib.request.urlretrieve(url, archive_path)\nout_path=os.path.join(tmpdir,"docker-extension")\nif url.endswith((".tar.gz",".tgz")):\n    with tarfile.open(archive_path,"r:gz") as tar:\n        members=[m for m in tar.getmembers() if os.path.basename(m.name)=="docker-extension"]\n        if not members:\n            raise SystemExit("docker-extension binary not found in archive")\n        member=members[0]\n        member.name=os.path.basename(member.name)\n        tar.extract(member, path=tmpdir)\n        out_path=os.path.join(tmpdir,"docker-extension")\nelse:\n    os.rename(archive_path, out_path)\nos.chmod(out_path, 0o755)\nprint(out_path)\n')
          if [ -z "$CLI_PATH" ]; then
            echo "Docker Extensions CLI binary missing after download." >&2
            exit 1
          fi
          sudo mv "$CLI_PATH" /usr/local/bin/docker-extension
          mkdir -p "$HOME/.docker/cli-plugins"
          ln -sf /usr/local/bin/docker-extension "$HOME/.docker/cli-plugins/docker-extension"

      - name: Verify Docker Extensions CLI
        run: docker extension version

      - name: Validate extension image
        run: docker extension validate dive-in:ci
